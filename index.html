<html>

<head>
<title>Learning WebGL &mdash; lesson 1</title>
<meta http-equiv="content-type" content="text/html; charset=ISO-8859-1">

<script type="text/javascript" src="glMatrix-0.9.5.min.js"></script>
    
<script id="shader-fs" type="x-shader/x-fragment">
    precision mediump float;

    void main(void) {
        gl_FragColor = vec4(1.0, 1.0, 1.0, 1.0);
    }
</script>

<script id="shader-vs" type="x-shader/x-vertex">
    attribute vec3 aVertexPosition;

    uniform mat4 uMVMatrix;
    uniform mat4 uPMatrix;

    void main(void) {
        gl_Position = uPMatrix * uMVMatrix * vec4(aVertexPosition, 1.0);
    }
</script>


<script type="text/javascript">
    function initGl(canvas) {
        var gl = canvas.getContext("experimental-webgl");
        gl.clearColor(0.0, 0.0, 0.0, 1.0);
        gl.enable(gl.DEPTH_TEST);
        return gl;
    }



    function createShader(gl, shaderType, shaderScriptId) {
        var shader = gl.createShader(shaderType);
        gl.shaderSource(shader, document.getElementById(shaderScriptId).text);
        gl.compileShader(shader)
        return shader;
    }

    function initShaders(gl) {
        var shaderProgram = gl.createProgram();

        gl.attachShader(shaderProgram, createShader(gl, gl.VERTEX_SHADER, "shader-vs"));
        gl.attachShader(shaderProgram, createShader(gl, gl.FRAGMENT_SHADER, "shader-fs"));

        gl.linkProgram(shaderProgram);

        gl.useProgram(shaderProgram);

        gl.enableVertexAttribArray(gl.getAttribLocation(shaderProgram, "aVertexPosition")); // ???

        return shaderProgram;
    }



    function createArrayBuffer(gl, options) {
        var b = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, b);
        if (typeof options !== 'undefined') { // copy properties from options to b
            Object.keys(options).forEach(function(k) {
                b[k] = options[k];
            });
        }
        return b;
    }

    function staticDrawArrayBuffer(gl, a) {
        gl.bufferData(gl.ARRAY_BUFFER, a, gl.STATIC_DRAW);
    }

    function initBuffers(gl) {
        var buffers = [];

        buffers.push(createArrayBuffer(gl, {
            itemSize: 3,
            numItems: 3,
            moveVector: [-1.5, 0.0, -7.0],
            glDrawMode: gl.TRIANGLES
        }));
        staticDrawArrayBuffer(gl, new Float32Array([
            0.0,  1.0,  0.0,
            -1.0, -1.0,  0.0,
            1.0, -1.0,  0.0
        ]));

        buffers.push(createArrayBuffer(gl, {
            itemSize: 3,
            numItems: 3,
            moveVector: [1.5, 0.0, -7.0],
            glDrawMode: gl.TRIANGLES
        }));
        staticDrawArrayBuffer(gl, new Float32Array([
            0.0,  1.0,  0.0,
            -1.0, -1.0,  0.0,
            1.0, -1.0,  0.0
        ]));

        buffers.push(createArrayBuffer(gl, {
            itemSize: 3,
            numItems: 4,
            moveVector: [0.0, 0.0, -11.0],
            glDrawMode: gl.TRIANGLE_STRIP
        }));
        staticDrawArrayBuffer(gl, new Float32Array([
            1.0,  1.0,  0.0,
            -1.0,  1.0,  0.0,
            1.0, -1.0,  0.0,
            -1.0, -1.0,  0.0
        ]));

        return buffers;
    }


    function uniformMatrix4fv(gl, shaderProgram, uniformName, value) { // writes data into uniform
        gl.uniformMatrix4fv(gl.getUniformLocation(shaderProgram, uniformName), false, value); // false = no transpose
    }

    function drawScene(gl, shaderProgram, buffers, viewportWidth, viewportHeight) {
        // set up viewport and clear
        gl.viewport(0, 0, viewportWidth, viewportHeight);
        gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);

        // create perspective matrix and write into uniform
        var pMatrix = mat4.create();
        mat4.perspective(45, viewportWidth / viewportHeight, 0.1, 100.0, pMatrix);
        uniformMatrix4fv(gl, shaderProgram, "uPMatrix", pMatrix);

        // draw buffers
        buffers.forEach(function(buffer) {
            gl.bindBuffer(gl.ARRAY_BUFFER, buffer);

            // set attrib (???)
            gl.vertexAttribPointer(gl.getAttribLocation(shaderProgram, "aVertexPosition"), buffer.itemSize, gl.FLOAT, false, 0, 0);

            // move model-view matrix to relative location specified by moveVector, write into gl uniform
            // create model-view matrix
            var mvMatrix = mat4.create();
            mat4.identity(mvMatrix);
            mat4.translate(mvMatrix, buffer.moveVector);
            uniformMatrix4fv(gl, shaderProgram, "uMVMatrix", mvMatrix);

            // draw buffer
            gl.drawArrays(buffer.glDrawMode, 0, buffer.numItems);
        });
    }



    function webGLStart() {
        var canvas =  document.getElementById("lesson01-canvas")

        var gl = initGl(canvas);

        var shaderProgram = initShaders(gl);

        var buffers = initBuffers(gl);

        drawScene(gl, shaderProgram, buffers, canvas.width, canvas.height);
    }
</script>


</head>


<body onload="webGLStart();">
    <canvas id="lesson01-canvas" style="border: none;" width="500" height="500"></canvas>
</body>

</html>
